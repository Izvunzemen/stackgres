#!/bin/sh
PROJECT_PATH="$(realpath "$(dirname "$0")/../../..")"
CONTAINER_NAME="${CONTAINER_NAME:-buildw-$(printf '%x' "$(date +%s)")}"
env > "/tmp/$CONTAINER_NAME.env"
# shellcheck disable=SC2046
docker run -it \
  --network bridge \
  --rm --name "$CONTAINER_NAME" \
  -v /etc/passwd:/etc/passwd:ro -v /etc/group:/etc/group:ro \
  -v /etc/shadow:/etc/shadow:ro -v /etc/gshadow:/etc/gshadow:ro \
  -u "$(id -u):$(id -g)" \
  $(id -G | tr ' ' '\n' | sed 's/^\(.*\)$/--group-add \1/') \
  --env-file "/tmp/$CONTAINER_NAME.env" \
  -v /tmp:/tmp \
  -v '/var/run/docker.sock:/var/run/docker.sock:rw' \
  -v "$HOME":"$HOME":rw -e PROMPT_COMMAND= \
  -v "$PROJECT_PATH:/project:rw" -w /project \
  "${IMAGE:-registry.gitlab.com/ongresinc/stackgres/ci:1.5}" sh -ec "$*"
EXIT_CODE="$?"
rm -f "/tmp/$CONTAINER_NAME.env"
exit "$EXIT_CODE"