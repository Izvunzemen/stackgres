#!/bin/sh
PROJECT_PATH="$(realpath "$(dirname "$0")/../../..")"
CONTAINER_NAME="${CONTAINER_NAME:-buildw-$(printf '%x' "$(date +%s)")}"
env > "/tmp/$CONTAINER_NAME.env"
IMAGE="${IMAGE:-registry.gitlab.com/ongresinc/stackgres/ci:1.13-$(uname -m)}"
# shellcheck disable=SC2046
docker run $(docker run -it "$IMAGE" true > /dev/null 2>&1 && printf '%s' -i || true) -t \
  --network bridge \
  --rm --name "$CONTAINER_NAME" \
  -v /etc/passwd:/etc/passwd:ro -v /etc/group:/etc/group:ro \
  -v /etc/shadow:/etc/shadow:ro -v /etc/gshadow:/etc/gshadow:ro \
  $(
  if [ "$(uname -s)" != Darwin ]
  then
    cat << EOF
  -u "$(id -u):$(id -g)" $(id -G | tr ' ' '\n' | sed 's/^\(.*\)$/--group-add \1/')
EOF
  fi
  ) \
  --env-file "/tmp/$CONTAINER_NAME.env" \
  -v /tmp:/tmp \
  -v '/var/run/docker.sock:/var/run/docker.sock:rw' \
  -v "$HOME":"$HOME":rw \
  -e HOME="$HOME" \
  -e PROMPT_COMMAND= \
  -v "$PROJECT_PATH:/project:rw" -w /project \
  "$IMAGE" \
  sh -ec "$*"
EXIT_CODE="$?"
rm -f "/tmp/$CONTAINER_NAME.env"
exit "$EXIT_CODE"
