#!/bin/sh

. "$SPEC_PATH/abstract/dbops-major-version-upgrade"

e2e_test() {
  run_test "Checking that major version upgrade timeout works correctly" check_major_version_upgrade_timed_out

  run_test "Checking that major version upgrade can be repeated if failed" check_major_version_upgrade_repeat
}

check_major_version_upgrade_timed_out() {
  reset_cluster

  cat << EOF | kubectl create -f -
apiVersion: stackgres.io/v1
kind: SGDbOps
metadata:
  name: major-version-upgrade
  namespace: $CLUSTER_NAMESPACE
spec:
  sgCluster: $CLUSTER_NAME
  op: majorVersionUpgrade
  timeout: PT1S
EOF

  if kubectl wait --timeout "$((E2E_TIMEOUT * 2))s" -n "$CLUSTER_NAMESPACE" sgdbops major-version-upgrade \
    --for condition=Failed
  then
    echo "SUCCESS. major version upgrade failed."
  else
    echo "FAILED. major version upgrade did not fail."
    return 1
  fi

  if [ "$(kubectl get -n "$CLUSTER_NAMESPACE" job \
    -l "cluster-name=$CLUSTER_NAME,db-ops=true" \
    -o name 2>/dev/null | wc -l)" = 1 ]
  then
    echo "SUCCESS. major version upgrade job was not removed after failure."
  else
    echo "FAILED. major version upgrade job was removed after failure."
    return 1
  fi

  kubectl delete sgdbops -n "$CLUSTER_NAMESPACE" major-version-upgrade

  if wait_until eval '[ "$(kubectl get -n "$CLUSTER_NAMESPACE" job \
    -l "cluster-name=$CLUSTER_NAME,db-ops=true" \
    -o name 2>/dev/null | wc -l)" = 0 ]'
  then
    echo "SUCCESS. major version upgrade job was removed after sgdbops was removed."
  else
    echo "FAILED. major version upgrade job was not removed after sgdbops was removed."
    return 1
  fi

  check_mock_data_samehost "$CLUSTER_NAME"
  check_mock_data_replication "$CLUSTER_NAME"
}

check_major_version_upgrade_repeat() {
    cat << EOF | kubectl create -f -
  apiVersion: stackgres.io/v1
  kind: SGDbOps
  metadata:
    name: major-version-upgrade
    namespace: $CLUSTER_NAMESPACE
  spec:
    sgCluster: $CLUSTER_NAME
    op: majorVersionUpgrade
EOF

  check_major_version_upgrade

  kubectl delete sgdbops -n "$CLUSTER_NAMESPACE" major-version-upgrade
}
